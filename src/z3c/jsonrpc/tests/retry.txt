=======
JSONRPC
=======


JSON-RPC server
---------------

The JSON server looks for content-type "application/json", and handles those
requests as JSON-RPC. The official mime-type for JSON is "application/json"
The old content type ``application/json-rpc`` is supported too.

  >>> from z3c.jsonrpc.tests.test_retry import IDemoContent
  >>> from z3c.jsonrpc.tests.test_retry import DemoContent
  >>> from z3c.jsonrpc.tests.test_retry import DemoView

Let's show how we can register a jsonrpc view:

  >>> from zope.configuration import xmlconfig
  >>> import z3c.jsonrpc
  >>> context = xmlconfig.file('meta.zcml', z3c.jsonrpc)
  >>> context = xmlconfig.string("""
  ... <configure
  ...     xmlns:z3c="http://namespaces.zope.org/z3c">
  ...   <z3c:jsonrpc
  ...       for="z3c.jsonrpc.tests.test_retry.IDemoContent"
  ...       class="z3c.jsonrpc.tests.test_retry.DemoView"
  ...       permission="zope.Public"
  ...       methods="goodResult badResult"
  ...       layer="z3c.jsonrpc.testing.IJSONRPCTestSkin"
  ...       />
  ... </configure>
  ... """, context)

Now we will setup a content object in our site:

  >>> site  = getRootFolder()
  >>> content = DemoContent()
  >>> site['content'] = content

  >>> siteURL = 'http://localhost/++skin++JSONRPCTestSkin'

Now we can call the method goodResult from our JSONRPC view:

  >>> from z3c.jsonrpc import testing
  >>> request = testing.TestRequest()
  >>> demoView = DemoView(content, request)
  >>> demoView.goodResult()
  u'good'

  >>> demoView.badResult()
  Traceback (most recent call last):
  ...
  ConflictError: database conflict error


Raise Retry (handleErrors=False)
--------------------------------

Now we force to run into Retry error. As you can see the ConflictError is the
original error of Retry. Note we use handleErrors=False here:

  >>> from z3c.jsonrpc.testing import JSONRPCTestProxy
  >>> proxy = JSONRPCTestProxy(siteURL + '/content', handleErrors=False)
  >>> proxy.badResult()
  Traceback (most recent call last):
  ...
  Retry: database conflict error


TODO: fix this missing 599 status
---------------------------------

  >>> from z3c.jsonrpc.testing import JSONRPCTestProxy
  >>> proxy = JSONRPCTestProxy(siteURL + '/content')
  >>> proxy.badResult()
  Traceback (most recent call last):
  ...
  ResponseError: Check proxy.error for error message

  >>> proxy.error
  u'ConflictError: database conflict error'
